<!DOCTYPE html>
<html>
  <head>
    <title>Benchmark</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script>
      (function() {
        var href = window.location.href;
        var baseuri = window.location.href.split("?")[1];
        var transport = null;

        (transport = /transport=(.+)&|transport=(.+)/.exec(href)) &&
                     transport && (transport[1] ? (transport = transport[1])
                                  : (transport = transport[2]));

        if (transport) {
          window.__FORCE_TRANSPORT_SOCKET__ = transport;
        }
      })();
    </script>
    <script type="text/javascript" src="../dist/lib.js"></script>
    <script>
      var ADDRESS_A = "localhost:7010/5";
      var ADDRESS_B = "localhost:7010/6";
      var running = false;
      var globalChan;
      var cases;
      var chanb;


      function onload() {
        if (typeof TestChannel == "undefined") {
          alert("Cannot find 'TestChannel' run './configure --environment test && make' first");
          return;
        }

        document.getElementById("start").disabled = false;

        if (document.addEventListener) {
          document.getElementById("start").addEventListener("click", start, false);
        } else {
          document.getElementById("start").attachEvent("onclick", start);
        }
      }


      function start(e) {
        var self = this;

        e.preventDefault();

        if (running) return;

        self.value = self.innerHTML = "Running...";
        self.disabled = true;

        runall(function(err) {
          if (err) {
            alert(err);
          }
          self.value = self.innerHTML = "Start Benchmark";
          self.disabled = false;
          running = false;
        });

        return false;
      }

      function runall(C) {
        var keys = [];
        var lastkey;

        for (var k in cases) keys.push(k);

        (function next(err, res) {
          var key = keys.shift();
          if (err) {
            document.getElementById(lastkey).innerHTML = err;
            return C(err);
          }
          if (lastkey) {
            document.getElementById(lastkey).innerHTML = (res / 1000) + "s";
          }
          if (!key) return C();
          lastkey = key;
          setTimeout(function() {
            cases[key](next);
          }, 1000);
        })();
      }

      function gettime() {
        return (new Date()).getTime();
      }

      function createPayload(size) {
        var index = size;
        var payload;

        if (typeof Uint8Array !== "undefined") {
          payload = new Uint8Array(size);
        } else {
          payload = new Array();
        }

        while (index--) {
          payload[index] = Math.floor(Math.random() * 256);
        }

        return payload;
      }

      function connect(C) {
        var chan = new TestChannel(ADDRESS_A);
        var t = gettime();
        chan.onopen = function() {
          return C(null, gettime() - t);
        };
      }

      function open(C) {
        globalChan = new TestChannel(ADDRESS_B, "rw");
        var t = gettime();
        globalChan.onopen = function() {
          return C(null, gettime() - t);
        };
      }

      function writeCase(messages, size) {
        return function(C) {
          var count = 0;
          data = createPayload(size);
          globalChan.onmessage = function(e) {
            if (++count == messages) {
              return C(null, gettime() - t);
            }
          };
          var t = gettime();
          for (var i = 0; i < messages; i++) {
            globalChan.send(data);
          }
        };
      }

      cases = {
        "connect": connect,
        "open": open,
        "write10x5": writeCase(10, 5),
        "write100x5": writeCase(100, 5),
        "write1000x5": writeCase(1000, 5),
        "write10000x5": writeCase(10000, 5),
        "write10x512": writeCase(10, 512),
        "write100x512": writeCase(100, 512),
        "write1000x512": writeCase(1000, 512),
        "write10000x512": writeCase(10000, 512),
        "write10x1024": writeCase(10, 1024),
        "write100x1024": writeCase(100, 1024),
        "write1000x1024": writeCase(1000, 1024),
        "write10000x1024": writeCase(10000, 1024)
      };

    </script>
    <style>
      ul {
        list-style: none;
      }
      ul li {
        position: relative;
        width: 400px;
      }
      ul li span {
        position: absolute;
        right: 0;
      }
    </style>
  </head>
  <body>
    <form>
      <button id="start" >Start Benchmark</button>
    </form>
    <ul>
      <li>Connect to server<span id="connect"></span></li>
      <li>Open channel<span id="open"></span></li>
      <li><hr></li>
      <li>write 10 à 5b<span id="write10x5"></span></li>
      <li>write 100 à 5b<span id="write100x5"></span></li>
      <li>write 1000 à 5b<span id="write1000x5"></span></li>
      <li>write 10000 à 5b<span id="write10000x5"></span></li>
      <li><hr></li>
      <li>write 10 à 512b<span id="write10x512"></span></li>
      <li>write 100 à 512b<span id="write100x512"></span></li>
      <li>write 1000 à 512b<span id="write1000x512"></span></li>
      <li>write 10000 à 512b<span id="write10000x512"></span></li>
      <li><hr></li>
      <li>write 10 à 1024b<span id="write10x1024"></span></li>
      <li>write 100 à 1024b<span id="write100x1024"></span></li>
      <li>write 1000 à 1024b<span id="write1000x1024"></span></li>
      <li>write 10000 à 1024b<span id="write10000x1024"></span></li>
      <li><hr></li>
    </ul>
  <script>
    onload();
  </script>
  </body>
</html>