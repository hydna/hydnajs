<!DOCTYPE html>
<html>
  <head>
    <title>Test suite</title>
    <script type="text/javascript" src="../dist/lib.js"></script>
    <script>
      var TESTS = [
        "test-1000-messages",
        "test-conn-close",
        "test-connect-close",
        "test-maxlimit",
        "test-mode",
        "test-pending-open",
        "test-read-write-only",
        "test-signal"
      ];

      var running = false;

      function start() {
        var self = this;

        if (running) return;

        self.value = self.innerHTML = "Running...";
        self.disabled = true;

        runall(function() {
          self.value = self.innerHTML = "Start";
          self.disabled = false;

          running = false;
        });
        return false;
      }


      function runall(C) {
        var tags = document.getElementsByTagName("li");
        var tests = [];
        var current;
        var href;

        for (var i = 0; i < tags.length; i++) {
          if (tags[i].className == "test" &&
              tags[i].childNodes[0].checked) {
            tests.push(tags[i]);
          }
        }

        (function next(err, result) {
          if (current) {
            if (err) {
              current.className += " error";
              current.innerHTML += " (" + err + ")";
            } else {
              current.className += " success";
              current.innerHTML += " (" + result + ")";
            }
          }
          current = tests.shift();
          if (current) {
            current.className += " running";
            href = current.getElementsByTagName("a")[0].getAttribute("href");
            runtest(href, next);
          } else {
            return C();
          }
        })();

        return false;
      }

      function runtest(href, C) {
        var body = document.getElementsByTagName("body")[0];
        var iframe;
        var index;

        function embedframe() {
          iframe = document.createElement("iframe");

          iframe.style.position = "absolute";
          iframe.style.top = "0px";
          iframe.style.left = "0px"
          iframe.style.width = "40px";
          iframe.style.height = "40px";
          iframe.src = href + "&callback=" + window.location.href;

          body.appendChild(iframe);

          window.k = iframe;

          poll();
        }

        if ((index = window.location.href.indexOf("#"))) {
          setTimeout(function() {
            window.location = window.location.href.substr(0, index) + "#";
            setTimeout(embedframe, 300);
          }, 100);
        } else {
          setTimeout(embedframe, 300);
        }


        function poll() {
          var m = /\#(.+)$/.exec(window.location.href);
          if (m) {
            body.removeChild(iframe);
            if (m[1].substr(0, 5) == "fail:") {
              C(m[1].substr(5));
            } else {
              C(null, m[1].substr(5));
            }
          } else {
            setTimeout(poll, 500);
          }
        }
      }

    </script>
    <style>
      .container {
        width: 480px;
        margin: auto;
      }
      form {
        background: #eeeeee;
      }
      ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      ul li.running {
        background: yellow;
      }
      ul li.success {
        background: lightgreen;
      }
      ul li.error {
        background: red;
      }

      iframe {
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <form>
        <h1>Test Suite</h1>
        <input id="test-websocket" name="test-websocket" type="checkbox" disabled>
        <label for="test-websocket">Run WebSocket tests</label><br>
        <input id="test-flash" name="test-flash" type="checkbox" disabled>
        <label for="test-flash">Run Flash tests</label><br>
        <input id="test-comet" name="test-comet" type="checkbox" disabled>
        <label for="test-comet">Run Comet tests</label><br><br>
        <button id="start">Start</button>
      </form>
      <!-- <ul class="test">
        <li><h2>WebSocket Binary Tests</h2></li>
        <li><input name="t" type="checkbox"><label for="t">1000-messages</li>
      </ul> -->
    </div>
    <script>
      var form = document.getElementsByTagName("form")[0];

      function createTestsFor(title, prefix, checkbox) {
        var tmpl = document.createElement("div");
        var name;
        var id;
        var ul;
        var li;
        var url;

        tmpl.innerHTML = '<ul class="test"><li>' +
                        '<h2>' + title + '</h2>' +
                        '</li></ul>';

        ul = tmpl.childNodes[0];

        form.parentNode.appendChild(ul);

        for (var i2 = 0; i2 < TESTS.length; i2++) {
          name = TESTS[i2];
          id = prefix + "-" + name;
          url = name + ".html?transport=" + prefix;
          tmpl.innerHTML = '<li class="test" id="' + id + '">' +
                           '<input name="' + id + '-chk" type="checkbox" checked>' +
                           '<label for="' + id + '-chk"><a href="' + url + '">' +
                           name + '</a></label>' +
                           '</li>'
          li = tmpl.childNodes[0];
          ul.appendChild(li);
        }

        checkbox.onclick = function() {
          var checked = checkbox.checked;
          var li;
          var input;
          for (var i = 0, l = ul.childNodes.length; i < l; i++) {
            li = ul.childNodes[i];
            for (var i2 = 0, l2 = li.childNodes.length; i2 < l2; i2++) {
              input = li.childNodes[i2];
              if (input.tagName.toLowerCase() == "input") {
                input.checked = checked;
              }
            }
          }
        };

      }

      if (TestChannel.WEBSOCKET) (function() {
        var elem = document.getElementById("test-websocket");
        elem.disabled = false;
        elem.checked = true;
        createTestsFor("WebSocket tests", "websocket", elem);
      })();

      if (TestChannel.FLASH) (function() {
        var elem = document.getElementById("test-flash");
        elem.disabled = false;
        elem.checked = true;
        createTestsFor("FlashSocket tests", "flash", elem);
      })();

      if (TestChannel.COMET) (function() {
        var elem = document.getElementById("test-comet");
        elem.disabled = false;
        elem.checked = true;
        createTestsFor("CometSocket tests", "comet", elem);
      })();

      document.getElementById("start").onclick = start;
    </script>
  </body>
</html>