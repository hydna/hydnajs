<!DOCTYPE html>
<html>
  <head>
    <title>Test suite</title>
    <script>
      var TRANSPORTS = [
        "WebSocket Binary Tests", "wsbin"
      ];
      var TESTS = [
        "1000-messages",
        "conn-close",
        "connect-close",
        "maxlimit",
        "mode",
        "pending-open",
        "read-write-only",
        "signal",
      ];
      var running = false;

      function start() {
        if (running) return;
        runall(function() {
          running = false;
        });
        return false;
      }


      function runall(C) {
        var tags = document.getElementsByTagName("li");
        var tests = [];
        var current;

        for (var i = 0; i < tags.length; i++) {
          if (tags[i].className == "test" &&
              tags[i].childNodes[0].checked) {
            tests.push(tags[i]);
          }
        }

        (function next(err, result) {
          if (current) {
            if (err) {
              current.className += " error";
              current.innerHTML += " (" + err + ")";
            } else {
              current.className += " success";
            }
          }
          current = tests.shift();
          return current ? runtest(current.getAttribute("id") + ".html", next)
                         : C();
        })();

        return false;
      }

      function runtest(src, C) {
        var body = document.getElementsByTagName("body")[0];
        var iframe = document.createElement("iframe");
        var index;

        if ((index = window.location.href.indexOf("#"))) {
          window.location = window.location.href.substr(0, index) + "#";
        }

        iframe.style.width = "0";
        iframe.style.height = "0";
        iframe.src = src + "?" + window.location.href;

        body.appendChild(iframe);

        window.k = iframe;
        (function poll() {
          var m = /\#(.+)$/.exec(window.location.href);
          if (m) {
            body.removeChild(iframe);
            if (m[1].substr(0, 5) == "fail:") {
              C(m[1].substr(5));
            } else {
              C(null);
            }
          } else {
            setTimeout(poll, 500);
          }
        })();
      }

    </script>
    <style>
      .container {
        width: 480px;
        margin: auto;
      }
      form {
        background: #eeeeee;
      }
      ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      ul li.success {
        background: lightgreen;
      }
      ul li.error {
        background: red;
      }

      iframe {
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <form>
        <h1>Test Suite</h1>
        <button id="start">Start</button>
      </form>
      <!-- <ul class="test">
        <li><h2>WebSocket Binary Tests</h2></li>
        <li><input name="t" type="checkbox"><label for="t">1000-messages</li>
      </ul> -->
    </div>
    <script>
      var form = document.getElementsByTagName("form")[0];
      var tmpl = document.createElement("div");
      var id;
      var ul;
      var li;
      var title;
      var prefix;

      for (var i=0; i < TRANSPORTS.length; i+=2) {
        title = TRANSPORTS[i];
        prefix = TRANSPORTS[i + 1];
        tmpl.innerHTML = '<ul class="test"><li>' +
                        '<h2>' + title + '</h2>' +
                        '</li></ul>';
        ul = tmpl.childNodes[0];
        form.parentNode.appendChild(ul);
        for (var i2 = 0; i2 < TESTS.length; i2++) {
          id = "test-" + prefix + "-" + TESTS[i2];
          tmpl.innerHTML = '<li class="test" id="' + id + '">' +
                           '<input name="' + id + '-chk" type="checkbox" checked>' +
                           '<label for="' + id + '-chk">' + id + '</label>' +
                           '</li>'
          li = tmpl.childNodes[0];
          ul.appendChild(li);
        }
      }

      document.getElementById("start").onclick = start;
    </script>
  </body>
</html>