<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>test-priority</title>
    <script type="text/javascript" src="common.js"></script>
    <script type="text/javascript" src="../dist/lib.js"></script>
  </head>
  <body>
    <h1>test-priority</h1>

    <script>
      function test(C) {
        var payloads = [];
        var chan = createTestChannel("rw");
        var done = false;
        var count = 0;
        
        chan.onopen = function(e) {
          for (var i = 0; i < 4; i++) {
            payloads.push(createString(64));
            chan.send(payloads[payloads.length - 1], i);
          }
          for (var i = 0; i < 4; i++) {
            payloads.push(createPayload(64));
            chan.send(payloads[payloads.length - 1], i);
          }
        };

        chan.onmessage = function(e) {
          var payload = payloads.shift();

          if (count < 4) {
            if (compareStrings(payload, e.data) == false ||
                e.priority !== count) {
              done = true;
              return C(new Error("diff error"));
            }
          } else {
            if (compareBuffers(payload, e.data) == false ||
                e.priority + 4 !== count) {
              done = true;
              return C(new Error("diff error"));
            }
          }

          if (++count == 8) {
            chan.close();
          }

        };

        chan.onerror = function(err) {
          done = true;
          C(err);
        };

        chan.onclose = function() { C(); };
      }

      initTest(30000, test);
    </script>
  </body>
</html>