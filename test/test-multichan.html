<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>test-multichan</title>
    <script type="text/javascript" src="common.js"></script>
    <script type="text/javascript" src="../dist/lib.js"></script>
  </head>
  <body>
    <h1>test-multichan</h1>

    <script>
      function test(C) {
        var startChannel = 100;
        var maxChannels = 200;
        var lastChannel = startChannel + maxChannels;
        var done = false;


        var readyCount = (function () {
          var count = maxChannels;
          var all = [];
          return function () {
            var chan;
            all.push(this);
            if (--count > 0) return;
            for (var i = 0; i < all.length; i++) {
              chan = all[i];
              chan.send(chan.id.toString());
            }
          };
        }());

        var closeCount = (function () {
          var count = maxChannels;
          return function () {
            if (--count > 0) return;
            return C();
          };
        }());

        function errorHandler (err) {
          done = true;
          C(err);
        }

        function prepareChannel (id) {
          var chan = createTestChannel("rw", id);
          chan.onopen = readyCount;
          chan.onerror = errorHandler;
          chan.onclose = closeCount;
          chan.onmessage = function (e) {
            if (parseInt(e.data) != id) {
              done = true;
              return C(new Error('Wrong message'));
            }
            this.close();
          };
        }

        for (var id = startChannel; id < lastChannel + 1; id++) {
          prepareChannel(id);
        }
      }

      initTest(30000, test);
    </script>
  </body>
</html>